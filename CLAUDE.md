# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

ARCompanion is a browser-based companion app for ARC Raiders that helps players optimize material gathering. Users bookmark items they want to craft, and the app analyzes which loot items to salvage/recycle for the most efficient material yield, using dual scoring modes (Maximum Yield vs Weight Conscious) with extensive filtering.

**Tech Stack:** SvelteKit + Svelte 5 (runes) + TypeScript + Tailwind v4 + shadcn-svelte + sql.js (client-side SQLite) + D3.js

## Commands

```bash
npm run dev          # Development server
npm run build        # Production build (static)
npm run preview      # Preview production build
npm run check        # Type checking
npm run test:e2e     # Playwright E2E tests
npm run db:build     # Rebuild database from RaidTheory/arcraiders-data
```

## Architecture

### Key Directories
- `src/routes/` - Single-page app (`+page.svelte` is main view, `layout.css` has global styles)
- `src/lib/components/` - Main components: MaterialsGrid, BubbleChart, SearchCommand, ItemDetailsDrawer, SettingsPanel, BookmarkedItemsBar, AppBar
- `src/lib/stores/` - Svelte 5 stores: `database.svelte.ts` (SQLite), `settings.svelte.ts` (unified bookmarks/filters with localStorage)
- `src/lib/types/` - `database.ts` (DB schema), `materials.ts` (scoring types)
- `static/data/` - `items.db` (SQLite, generated by `npm run db:build`)
- `static/images/items/` - Item icons as `{item_id}.png`

### Path Aliases (components.json)
- `@/components` → `$lib/components`
- `@/ui` → `$lib/components/ui`
- `@/lib` → `$lib`

## Key Patterns

- **Svelte 5 Runes**: Use `$state()`, `$derived()`, `$props()`, `$effect()` (not legacy $ stores)
- **Styling**: Tailwind v4 with OKLCH colors, `cn()` utility for className merging
- **TypeScript**: Strict mode, path alias `$lib` → `src/lib/`

## Database

### Schema
Client-side SQLite loaded via sql.js. See `static/schema.sql` for full documentation.

**Tables:**
- `items` - Core item data (id, name, type, rarity, value, weight_kg, is_craftable, effects, etc.)
- `crafting_recipes` - item_id, ingredient_id, quantity
- `crafting_benches` - item_id, bench_type, station_level
- `recycling_outputs` / `salvaging_outputs` - item_id, output_id, quantity
- `item_categories` / `item_category_links` - Where items are found

### Database Store (`src/lib/stores/database.svelte.ts`)

```typescript
import { db } from '$lib/stores/database.svelte';

// Reactive status: 'loading' | 'ready' | 'error'
if (db.status === 'ready') {
  const items = db.query<Item>('SELECT * FROM items WHERE rarity = ?', ['epic']);
  const item = db.queryOne<Item>('SELECT * FROM items WHERE id = ?', ['item-id']);
}
```

**API:** `db.status`, `db.error`, `db.query<T>(sql, params?)`, `db.queryOne<T>(sql, params?)`
**Types:** See `src/lib/types/database.ts` for `Item`, `CraftingRecipe`, etc.

## Settings Store (`src/lib/stores/settings.svelte.ts`)

Unified store for bookmarks, filters, and scoring with localStorage persistence (auto-save, 100ms debounce).

```typescript
import { settings } from '$lib/stores/settings.svelte';

// Bookmarks
settings.toggle('item-id');
settings.isBookmarked('item-id');
settings.bookmarkedItems; // Set<string>

// Material filters
settings.scoringMethod = 'max_yield' | 'weight_conscious';
settings.toggleMaterialRarity('Epic');
settings.maxSourceValueEnabled = true;
settings.maxSourceValue = 500;

// Export/Import
const json = settings.exportSettings();
settings.importSettings(json, validateBookmarks: true);
```

**Store sections:** `bookmarks`, `graphFilters` (bubble chart), `materialFilters` (scoring + filters), `sourceFilters` (hidden items)

## Material Scoring

MaterialsGrid analyzes bookmarked items to score loot items for salvaging/recycling efficiency.

**Modes:**
- `max_yield` - Maximize material output (ignore weight)
- `weight_conscious` - Optimize materials per kg

**Scoring:** Considers material demand, output diversity, rarity bonus, and weight (weight_conscious mode only). Items auto-categorized as "Salvage" or "Recycle" based on best method.

**Filtering:** Rarity, category, source type, value threshold, manual hide
